#!/usr/bin/env bash

set -ex

DIR=`pwd`

bunx cep -c src -o lib

exe=$1

ini=xxai-$exe.ini

fp=/etc/supervisor/conf.d/$ini

sudo cp $DIR/supervisor/$ini $fp

rtx="$(which rtx) env"

if [ -x "$(command -v brew)" ]; then
  BIN=$(dirname $(which brew))
fi


sd -s "\$EXE" "bash -c \"export HOME=$HOME && cd $DIR && export PATH=\$PATH:$BIN:$(dirname $(which realpath)) && [[ -f /etc/profile ]] && source /etc/profile; exec $(which timeout) 1d $(which direnv) exec . $DIR/$exe.sh\"" $fp

cd /etc

sudo supervisorctl update
sleep 3
sudo supervisorctl status
